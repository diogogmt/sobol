#content.xfluid
  a(name='line')
  #gallery_wrapper.portlet.x8
    .portlet-header
      h4 Image Gallery
      //- p
      //-   button(rel="#custom", type="button") custom
      //- div#custom.apple_overlay
      //-  | Hello There

    .portlet-content
      div#tagscope
        form#magicboxform(name="magicboxform", action="")
            input#addtagType(name="tagtype", value="tag", type="hidden")
            input#addFilter(name="addFilter", value="Add a Tag Filter",
              type="text")
            button#searchMediaBtn.btn 
              |Search
        div#searchTags.tagList
          

        
        
      br
      br
      ul#mediaList.gallery
      div#mediaOverlay

   .portlet.x4
        .portlet-header
          h4 Upload File
        //
           .portlet-header 
        .portlet-content
          form#add-user-form.form.label-top
            .field
              label(for='filename') File Name 
              input#fileName(name='filename', size='30', type='text', value='')
            .field
              label(for='description') Description 
              input#description(name='description', size='30', type='text', value='')
            .field.clearfix
              label(for='file') File Upload 
              input#file.file(name="file", style='opacity: 0;', size='35', type='file')

            div.field
              label(for='tags') Tags 
              div#tagsList.field

            div.field
              select#tagsAvailable
                option(value="default") Select a tag

            div.field
              input#tagName(name='tagName', size='20',
                type='text', value='tag 7')
              button#createTag.btn Add Tag

            input#newTags(name='newTags', type='hidden', value='')
            input#existingTags(name='existingTags', type='hidden', value='')

            div.field
            .buttonrow
              button#createMedia.btn Upload File


script(id="searchMediaTmpl", type="text/x-jQuery-tmpl")
  div.tag(query="${name}", class="${name}")
    div.removeFilter(query="${name}")
    div.filter
      span.name
        |${name}

script(id="mediaTagsTmpl", type="text/x-jQuery-tmpl")
  div.tag(query="${name}", class="${name}")
    div.removeTag(query="${name}")
    div.filter
      span.name
        |${name}


script(id="availableTagsTmpl", type="text/x-jQuery-tmpl")
  option(value="${_id}") ${name}


script(id="mediaOverlayTmpl", type="text/x-jQuery-tmpl")
  div.apple_overlay(id="${src}")
    img(alt='', src='/media/${src}')


script(id="mediaGalleryTmpl", type="text/x-jQuery-tmpl")
  li(id="${_id}", data-id="${_id}")
    b ${name}
    br
    img(alt='', src='/media/${thumbnail}', width='150', height='150')
    .actions
      button.btn.btn-orange.btn-small.various(rel='#${src}') View
      button.btn.btn-orange.btn-small.editImg(href='#editImage') Edit
      button.btn.btn-grey.btn-small.delete.deleteImage(media="${_id}") Delete


script
  var searchFilters = new Array()
    , existingMediaTags = {}
    , newMediaTags = new Array();
 
  function bindImageListeners() {
    console.log("bindImageListeners");
    $("button[rel]").overlay({mask: '#000', effect: 'apple'});
    /*
    *   Update media
    */
    $(".editImg").fancybox({
      'titlePosition'   : 'inside',
      'transitionIn'    : 'none',
      'transitionOut'   : 'none'
    });
    $(".deleteImage").click(function () {
      var mediaID = $(this).attr("media")
        , that = this;
      $.post("/media/delete", { "mediaID": mediaID }, function (data) {
        // $("#"+mediaID).remove();
        searchMedia();
        setExistingTags();
      })
    });
  }
 
  function searchMedia () {
    console.log("search media");
    console.log(searchFilters);
    $.post("/media/search", { filters: searchFilters }, function(data) {
      console.log("post media search");
      console.log(data);
      if (data) {
      // $("#mediaGalleryTmpl").tmpl(data).appendTo("#mediaList");
      $("#mediaOverlayTmpl").tmpl(data).appendTo("#mediaOverlay");
 
      $('.gallery').quicksand( $("#mediaGalleryTmpl").tmpl(data), {
          adjustHeight: 'dynamic'
        }, function () {
          console.log("quicksand callback");
          bindImageListeners();
        });
      }
      else {
        $('.gallery').empty();
      }
      
    });
  }
 
  function setExistingTags() {
    console.log("setExistingTags");
    $.get("/tags/get", function (data) {
      console.log("get tags");
      // console.log(data);
      // console.log($("#availableTagsTmpl"));
      $("#tagsAvailable").empty();
      $("#newTags").val("");
      $("#existingTags").empty("");
      $("#availableTagsTmpl").tmpl(data).appendTo("#tagsAvailable");
      
    });
  }
 
 
  $(document).ready(function () {
    searchMedia();
    setExistingTags();
 
    // bind form using 'ajaxForm' 
    $('#add-user-form').ajaxForm({
      url:       "media/create",
      type:      "POST",
      dataType:  "json",
      clearForm: true,
      beforeSubmit: function (formData, jqForm, options) {
        // formData is an array of objects containing the values of the form
        // jqForm is the html form element
        // options are the object initialized with ajaxForm
        // maybe validate the for before submiting
        // if form is not valid return false
        return true;
      },
      success: function (data) {
        console.log("create media success");
        // $("#mediaGalleryTmpl").tmpl(data).prependTo("#mediaList");
        // bindImageListeners();
        searchFilters = new Array();
        searchMedia();
        existingMediaTags = {};
        newMediaTags = new Array();
        $("#tagsList").empty();
        setExistingTags();
        
      },
    });
 
    $("#searchMediaBtn").click(function (e) {
      console.log("search media button click");
      var data = {
        name: $("#addFilter").val()
      };
 
      searchFilters.push(data.name);
      searchMedia();
 
      var item = $("#searchMediaTmpl").tmpl(data).appendTo("#searchTags");
      console.log(item);
      console.log($(item).find(".removeFilter"));
      $(item).find(".removeFilter").click( function (e) {
        console.log("remove filter click");
        console.log($(this).attr("query"));
        $(this).parent().empty();
        searchFilters.splice(searchFilters.indexOf($(this).attr("query")), 1);
        searchMedia();
      });
      
      return false;
    }); // CLOSE searchMediaBtn.click
 
    $("#createTag").click(function (e) {
      console.log("create tag click");
      var tag = {
        name: $("#tagName").val(),
      };
      newMediaTags.push(tag.name);
      $("#tagName").val("")
      $("#mediaTagsTmpl").tmpl(tag).appendTo("#tagsList");
      
      $(".removeTag").click(function (e) {
        console.log("remove tag click");
        $(this).parent().empty();
        newMediaTags.splice(newMediaTags.indexOf($(this).attr("query")), 1);
      });
 
      return false;
    }); // CLOSE createTag.click
 
  $("#tagsAvailable").change(function () {
    console.log("tags available change");
    Array.prototype.slice.apply(existingMediaTags, 
      [
        Array.prototype.indexOf.apply(existingMediaTags,
          ["aaaa"]), 1
      ]
    );
    if ($("#tagsAvailable").val() == "default") {
      return false;
    }
    var tag = {
      name: $("#tagsAvailable :selected").text(),
    };
    console.log($("tagsAvailable").val());
    console.log($("tagsAvailable").text());
    console.log(tag);
    existingMediaTags[tag.name] = $("#tagsAvailable").val();
    // existingMediaTags.push([$("#tagsAvailable").val() = tag.name]);
    var item = $("#mediaTagsTmpl").tmpl(tag).appendTo("#tagsList");
    console.log("item");
    console.log($(item).find(".removeTag"));
    $(item).find(".removeTag").click( function (e) {
      console.log("remove existing tag click");
      $(this).parent().empty();
      for (var key in  existingMediaTags) {
        console.log("key: " + key);
        if (key === tag.name) {
          delete existingMediaTags[key];
          console.log("deleting: " + key + " from existingMediaTags obj");
          console.log(existingMediaTags);
        }
      }
    })
    $('#tagsAvailable :selected').remove(); 
  }); // CLOSE tagsAvailable.change
 
  $("#createMedia").click(function (e) {
    console.log("create media button");
    console.log(existingMediaTags);
    console.log(newMediaTags);
    var tagsArray = new Array();
    for (var key in  existingMediaTags) {
      console.log("key: " + key);
      tagsArray.push(existingMediaTags[key]);
    }
    console.log(tagsArray);
    $("#newTags").val(newMediaTags);
    $("#existingTags").val(tagsArray);
  }); // CLOSE createMedia.click
 
  }); // CLOSE document.ready